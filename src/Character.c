#include <JamEngine.h>
#include <Character.h>
#include <malloc.h>
#include <SandConstants.h>
#include <Message.h>

// Getters and setters at the bottom

////////////////////////////////////////////////////////////////////
bool sbProcessCharacterDeath(JamWorld *world, JamEntity *enemy) {
	if (sbGetCharacterDead(enemy)) {
		enemy->rot += ENEMY_DEATH_ROT_SPEED;
		enemy->vSpeed += COMICAL_GRAVITY_ACCELERATION - GRAVITY_ACCELERATION;
		enemy->alpha = (uint8) (sbGetCharacterFadeOut(enemy) / ENEMY_FADE_OUT_TIME * 255);
		sbTickCharacterFadeOut(enemy);
		if (sbGetCharacterFadeOut(enemy) <= 0) {
			enemy->destroy = true;
		}
		return false;
	} else {
		return true;
	}
}
////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
void sbProcCharacterPhysics(JamWorld *world, JamEntity *self, bool jump, double movement, bool friction,
							double acceleration, double jumpSpeed, double maxVelocity, bool *jumped) {
	// Don't accept controls while dialogue is active
	jump = sbMessageActive() ? false : jump;
	movement = sbMessageActive() ? 0 : movement;

	bool onGround = jamEntityTileMapCollision(self, world->worldMaps[WORLD_WALL_LAYER], self->x, self->y + 1);

	// Gravity
	self->vSpeed += GRAVITY_ACCELERATION * jamRendererGetDelta();
	if (onGround) {
		self->hSpeed += movement * acceleration;
		if (movement == 0) {
			double old = sign(self->hSpeed);
			if (friction)
				self->hSpeed -= old * COEFFICIENT_OF_FRICTION * jamRendererGetDelta();
			if (old != sign(self->hSpeed))
				self->hSpeed = 0;
		}

	} else {
		// Slower movement mid-air
		self->hSpeed += movement * AIR_VELOCITY_CONTROL * jamRendererGetDelta();
	}

	// Jump if possible
	if (onGround && jump) {
		self->vSpeed += jumpSpeed;
		if (jumped) *jumped = true;
	}

	// Clamp velocity between +/- max velocity
	self->hSpeed = clamp(self->hSpeed, -maxVelocity, maxVelocity);
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
void sbProcCharacterAnimations(JamWorld *world, JamEntity *self, JamSprite *walking, JamSprite *standing,
							   JamSprite *jumping, bool stopRot) {
	// Animation control
	if (jamEntityTileMapCollision(self, world->worldMaps[WORLD_WALL_LAYER], self->x, self->y + 1)) {
		if (self->hSpeed != 0) {
			jamEntitySetSprite(self, walking);
			self->rot = stopRot ? 0 : self->rot;
		} else {
			jamEntitySetSprite(self, standing);
			self->rot = stopRot ? 0 : self->rot;
		}
	} else {
		jamEntitySetSprite(self, jumping);
	}
	if (self->hSpeed > 0)
		self->scaleX = 1;
	else if (self->hSpeed < 0)
		self->scaleX = -1;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
void sbProcCharacterCollisions(JamWorld *world, JamEntity *self, bool *horizontal, bool *vertical) {
	// Horizontally, we can go climb 1 block at a time without jumping if there is not a block above
	// us and we are currently on the ground (to prevent ledge grabbing)
	if (jamEntityTileMapCollision(self, world->worldMaps[WORLD_WALL_LAYER], self->x + self->hSpeed, self->y) &&
		!jamEntityTileMapCollision(self, world->worldMaps[WORLD_WALL_LAYER], self->x + self->hSpeed, self->y - 10) &&
		jamEntityTileMapCollision(self, world->worldMaps[WORLD_WALL_LAYER], self->x, self->y + 1))
		self->y -= BLOCK_SIZE + 1;

	// Collisions
	if (jamEntityTileMapCollision(self, world->worldMaps[WORLD_WALL_LAYER], self->x + self->hSpeed, self->y)) {
		jamEntitySnapX(self, world->worldMaps[WORLD_WALL_LAYER], (int) sign(self->hSpeed));
		self->hSpeed = 0;
		if (horizontal) *horizontal = true;
	}
	if (jamEntityTileMapCollision(self, world->worldMaps[WORLD_WALL_LAYER], self->x, self->y + self->vSpeed)) {
		jamEntitySnapY(self, world->worldMaps[WORLD_WALL_LAYER], (int) sign(self->vSpeed));
		self->vSpeed = 0;
		if (vertical) *vertical = true;
	}
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
void sbProcCharacterMovement(JamWorld *world, JamEntity *self) {
	self->x += self->hSpeed;
	self->y += self->vSpeed;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
void onCharacterCreate(JamWorld* world, JamEntity* self) {
	self->data = calloc(1, sizeof(CharacterData));
	if (!self->data)
		jSetError(ERROR_ALLOC_FAILED, "Failed to create character data for type %i", self->type);
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
void onCharacterDestroy(JamWorld* world, JamEntity* self) {
	free(self->data);
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////
double sbGetCharacterMoveTime(JamEntity *enemy) {
	return ((CharacterData*)enemy->data)->State.moveTime;
}
////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////
void sbSetCharacterMoveTime(JamEntity *enemy, double moveTime) {
	((CharacterData*)enemy->data)->State.moveTime = moveTime;
}
////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////
void sbTickCharacterMoveTime(JamEntity *enemy) {
	((CharacterData*)enemy->data)->State.moveTime -= jamRendererGetDelta();
}
////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////
double sbGetCharacterPauseTime(JamEntity *enemy) {
	return ((CharacterData*)enemy->data)->State.pauseTime;
}
////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////
void sbSetCharacterPauseTime(JamEntity *enemy, double pauseTime) {
	((CharacterData*)enemy->data)->State.pauseTime = pauseTime;
}
////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////
void sbTickCharacterPauseTime(JamEntity *enemy) {
	((CharacterData*)enemy->data)->State.pauseTime -= jamRendererGetDelta();
}
////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////
double sbGetCharacterMovement(JamEntity *enemy) {
	return ((CharacterData*)enemy->data)->State.movement;
}
////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////
void sbSetCharacterMovement(JamEntity *enemy, double movement) {
	((CharacterData*)enemy->data)->State.movement = movement;
}
////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////
double sbGetCharacterFadeOut(JamEntity *enemy) {
	return ((CharacterData*)enemy->data)->State.fadeOut;
}
////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////
bool sbGetCharacterDead(JamEntity *enemy) {
	return ((CharacterData*)enemy->data)->State.fadeOut > 0;
}
////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////
void sbSetCharacterFadeOut(JamEntity *enemy, double fadeOut) {
	((CharacterData*)enemy->data)->State.fadeOut = fadeOut;
}
////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////
void sbTickCharacterFadeOut(JamEntity *enemy) {
	((CharacterData*)enemy->data)->State.fadeOut -= jamRendererGetDelta();
}
////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
bool sbGetCharacterRolling(JamEntity* ent) {
	return ((CharacterData*)ent->data)->State.rolling;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
double sbGetCharacterRollDamage(JamEntity* ent) {
	return ((CharacterData*)ent->data)->Stats.rollDamage;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
void sbSetCharacterRollDamage(JamEntity* ent, double thorns) {
	((CharacterData*)ent->data)->Stats.thorns = thorns;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
double sbGetCharacterThorns(JamEntity* ent) {
	return ((CharacterData*)ent->data)->Stats.thorns;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
void sbSetCharacterThorns(JamEntity* ent, double thorns) {
	((CharacterData*)ent->data)->Stats.thorns = thorns;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
double sbGetCharacterRollSpeed(JamEntity* ent) {
	return ((CharacterData*)ent->data)->Stats.rollSpeed;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
void sbSetCharacterRollSpeed(JamEntity* ent, double rollSpeed) {
	((CharacterData*)ent->data)->Stats.rollSpeed = rollSpeed;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
double sbGetCharacterRollDuration(JamEntity* ent) {
	return ((CharacterData*)ent->data)->Stats.rollDuration;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
void sbSetCharacterRollDuration(JamEntity* ent, double rollDuration) {
	((CharacterData*)ent->data)->Stats.rollDuration = rollDuration;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
double sbGetCharacterRollCooldown(JamEntity* ent) {
	return ((CharacterData*)ent->data)->Stats.rollCooldown;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
void sbSetCharacterRollCooldown(JamEntity* ent, double rollCooldown) {
	((CharacterData*)ent->data)->Stats.rollCooldown = rollCooldown;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
double sbGetCharacterHp(JamEntity* ent) {
	return ((CharacterData*)ent->data)->Stats.hp;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
void sbSetCharacterHp(JamEntity* ent, double hp) {
	((CharacterData*)ent->data)->Stats.hp = hp;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
double sbGetCharacterMaxHP(JamEntity* ent) {
	return ((CharacterData*)ent->data)->Stats.maxHP;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
void sbSetCharacterMaxHP(JamEntity* ent, double maxHP) {
	((CharacterData*)ent->data)->Stats.maxHP = maxHP;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
double sbGetCharacterAirRes(JamEntity* ent) {
	return ((CharacterData*)ent->data)->Stats.airRes;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
void sbSetCharacterAirRes(JamEntity* ent, double airRes) {
	((CharacterData*)ent->data)->Stats.airRes = airRes;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
const char* sbGetCharacterPassiveDialogue(JamEntity* ent) {
	return ((CharacterData*)ent->data)->Info.passiveDialogue;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
void sbSetCharacterPassiveDialogue(JamEntity* ent, const char* passiveDialogue) {
	((CharacterData*)ent->data)->Info.passiveDialogue = passiveDialogue;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
const char* sbGetCharacterName(JamEntity* ent) {
	return ((CharacterData*)ent->data)->Info.name;
}
////////////////////////////////////////////////////////////////////////

////////////////////////////////////////////////////////////////////////
void sbSetCharacterName(JamEntity* ent, const char* name) {
	((CharacterData*)ent->data)->Info.name = name;
}
////////////////////////////////////////////////////////////////////////
